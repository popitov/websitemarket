{% extends "base.html" %}
{% block content %}
<section class="section">
  <div class="section-heading">
    <h1>–û–ø–ª–∞—Ç–∞</h1>
    <span class="tag">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞</span>
  </div>

  <div class="card pad pay-card" id="pay-block">
    {% if amount and amount > 0 %}
    <div class="center"><strong>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</strong> {{ amount }} ‚ÇΩ</div>
    {% endif %}

    {% if is_crypto %}
    <p class="muted">–û–ø–ª–∞—Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ CryptoBot. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—á—ë—Ç –≤ Telegram, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É –∏ –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤—Ä—É—á–Ω—É—é.</p>
    <div class="center">
      {% if redirect_url %}
      <a class="btn" href="{{ redirect_url }}" target="_blank" rel="noopener">üîó –û—Ç–∫—Ä—ã—Ç—å CryptoBot –¥–ª—è –æ–ø–ª–∞—Ç—ã</a>
      {% else %}
      <span class="muted">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ –∑–∞–Ω–æ–≤–æ.</span>
      {% endif %}
    </div>
    {% else %}
    <p class="muted">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ —á–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–∞–Ω–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –ø–æ –°–ë–ü. –ï—Å–ª–∏ QR –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –≤—Ä—É—á–Ω—É—é.</p>

    <div id="qr-wrap" class="center">
      <div id="qr-loading" class="spinner">–ì–æ—Ç–æ–≤–∏–º QR‚Ä¶</div>
      <img id="qr-img" src="" alt="QR" style="display:none; max-width:280px;"/>
    </div>

    <div id="fallback" class="center" style="display:none">
      <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∏—Ç—å QR. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã –≤—Ä—É—á–Ω—É—é.</p>
      {% if redirect_url %}
        <a class="btn" href="{{ redirect_url }}" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã</a>
      {% endif %}
    </div>
    {% endif %}

    <div class="center" style="margin-top: 1.5rem;">
      <button id="check-btn" class="btn" type="button" onclick="checkStatus()">‚òëÔ∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–ª–∞—Ç—ë–∂</button>
      <div id="status" class="status-indicator">–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã‚Ä¶</div>
    </div>
  </div>
</section>

<script>
const pid = "{{ payment_id }}";
const isCrypto = {{ 'true' if is_crypto else 'false' }};

async function loadQR() {
  try {
    const r = await fetch(`/api/platega_qr/${pid}`);
    const data = await r.json();
    if (data.ok && data.qr_url) {
      const img = document.getElementById('qr-img');
      img.src = data.qr_url;
      img.style.display = 'block';
      document.getElementById('qr-loading').style.display = 'none';
    } else {
      document.getElementById('qr-loading').style.display = 'none';
      document.getElementById('fallback').style.display = 'block';
    }
  } catch (e) {
    document.getElementById('qr-loading').style.display = 'none';
    document.getElementById('fallback').style.display = 'block';
  }
}

async function checkStatus() {
  const statusNode = document.getElementById('status');
  statusNode.innerText = '–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞—Ç—ë–∂‚Ä¶';
  try {
    const r = await fetch(`/api/payment_status/${pid}`);
    const data = await r.json();
    if (data.ok && data.status === 'confirmed') {
      statusNode.innerText = '‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';
      setTimeout(() => { window.location = '/account'; }, 1200);
    } else if (data.ok && data.status === 'pending') {
      statusNode.innerText = '‚ö†Ô∏è –ü–ª–∞—Ç—ë–∂ –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á—É—Ç—å –ø–æ–∑–∂–µ.';
    } else if (data.ok) {
      statusNode.innerText = `‚ùå –ü–ª–∞—Ç—ë–∂ –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω (—Å—Ç–∞—Ç—É—Å: ${data.status || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'})`;
    } else {
      statusNode.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞.';
    }
  } catch (e) {
    statusNode.innerText = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞.';
  }
}

if (!isCrypto) {
  loadQR();
}
</script>
{% endblock %}
